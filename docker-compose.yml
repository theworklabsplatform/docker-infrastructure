version: '3.8'

services:
  # ============================================
  # REVERSE PROXY - Routes all traffic by hostname
  # ============================================
  nginx:
    image: nginx:latest
    container_name: infrastructure-nginx
    restart: on-failure
    ports:
      - '${PUBLIC_PORT:-80}:80'
      - '${PUBLIC_SSL_PORT:-443}:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./shared/certbot/www:/var/www/certbot:ro
      - ./shared/certbot/conf:/etc/letsencrypt:ro
    networks:
      - infrastructure_network
    depends_on:
      - bigcapital-server
      - bigcapital-webapp
      # - bigcapital-docs
      - corteza-server
      - corteza-docs
      - whatsapp-chat

    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost/health"]
    #   interval: 30s
    #   timeout: 10s
    #   retries: 3
    #   start_period: 40s

  # ============================================
  # BIGCAPITAL - Accounting Application
  # ============================================
  bigcapital-webapp:
    container_name: bigcapital-webapp
    image: venugopalhegde/theworklabs-accounts-webapp:v6
    platform: linux/amd64
    restart: on-failure
    networks:
      - infrastructure_network
    env_file:
      - apps/bigcapital/.env
    expose:
      - '80'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  bigcapital-docs:
    container_name: bigcapital-docs
    image: venugopalhegde/theworklabs-accounts-docs:v2
    platform: linux/amd64
    restart: on-failure
    networks:
      - infrastructure_network
    expose:
      - '80'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  bigcapital-server:
    container_name: bigcapital-server
    image: venugopalhegde/theworklabs-accounts-server:v15
    platform: linux/amd64
    restart: on-failure
    networks:
      - infrastructure_network
    env_file:
      - apps/bigcapital/.env
    expose:
      - '3000'
    depends_on:
      - bigcapital-mysql
      - bigcapital-mongo
      - bigcapital-redis
      - bigcapital-database-migration
    links:
      - bigcapital-mysql
      - bigcapital-mongo
      - bigcapital-redis

  bigcapital-database-migration:
    container_name: bigcapital-database-migration
    image: venugopalhegde/theworklabs-accounts-migration:v2
    platform: linux/amd64
    env_file:
      - apps/bigcapital/.env
    environment:
      # Database
      - DB_HOST=bigcapital-mysql
      - DB_PORT=5432
      - DB_USER=bigcapital
      - DB_PASSWORD=bigcapital
      - DB_DIALECT=postgres
      - SYSTEM_DB_NAME=bigcapital_system
      # Tenants databases
      - TENANT_DB_NAME_PERFIX=bigcapital_tenant_
    depends_on:
      - bigcapital-mysql
    networks:
      - infrastructure_network

  bigcapital-mysql:
    container_name: bigcapital-mysql
    image: postgres:15
    restart: on-failure
    networks:
      - infrastructure_network
    environment:
      - POSTGRES_DB=bigcapital_system
      - POSTGRES_USER=bigcapital
      - POSTGRES_PASSWORD=bigcapital
    volumes:
      - bigcapital-mysql:/var/lib/postgresql/data
    expose:
      - '5432'

  bigcapital-mongo:
    container_name: bigcapital-mongo
    restart: on-failure
    build:
      context: ./apps/bigcapital/docker/mongo
    networks:
      - infrastructure_network
    volumes:
      - bigcapital-mongo:/var/lib/mongodb
    expose:
      - '27017'
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3

  bigcapital-redis:
    container_name: bigcapital-redis
    restart: on-failure
    build:
      context: ./apps/bigcapital/docker/redis
    networks:
      - infrastructure_network
    volumes:
      - bigcapital-redis:/data
    expose:
      - '6379'

  bigcapital-gotenberg:
    image: gotenberg/gotenberg:7
    container_name: bigcapital-gotenberg
    restart: on-failure
    networks:
      - infrastructure_network
    expose:
      - '3000'

  # ============================================
  # CORTEZA - CRM Application
  # ============================================
  corteza-server:
    container_name: corteza-server
    image:   venugopalhegde/corteza:v24
    platform: linux/amd64
    restart: always
    networks:
      - infrastructure_network
    env_file:
      - apps/corteza/.env
    depends_on:
      - corteza-db
    volumes:
      - corteza-data:/data
    expose:
      - '80'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  corteza-docs:
    container_name: corteza-docs
    image: venugopalhegde/corteza-docs:v3
    platform: linux/amd64
    restart: always
    networks:
      - infrastructure_network
    expose:
      - '80'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # WHATSAPP CHAT APPLICATION
  # ============================================
  whatsapp-chat:
    image: venugopalhegde/whatsapp-chat:v2
    platform: linux/amd64
    container_name: whatsapp-chat-app
    ports:
      - "3000:3000"
    env_file:
      - apps/whatsapp-chat/.env
    environment:
      # Runtime environment variables
      - NODE_ENV=production
      - NEXT_TELEMETRY_DISABLED=1
    restart: unless-stopped
    networks:
      - infrastructure_network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  corteza-db:
    container_name: corteza-db
    image: postgres:15
    platform: linux/amd64
    restart: always
    environment:
      POSTGRES_USER: corteza
      POSTGRES_PASSWORD: corteza
    expose:
      - '5432'
    networks:
      - infrastructure_network
    volumes:
      - corteza-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U corteza"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # SSL CERTIFICATE MANAGEMENT (Optional)
  # ============================================
  certbot:
    image: certbot/certbot:latest
    container_name: infrastructure-certbot
    restart: unless-stopped
    # profiles: ["${ENABLE_CERTBOT:-}"]
    networks:
      - infrastructure_network
    volumes:
      - ./shared/certbot/www:/var/www/certbot:rw
      - ./shared/certbot/conf:/etc/letsencrypt:rw
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew -q; sleep 12h & wait $${!}; done;'"

# ============================================
# VOLUMES
# ============================================
volumes:
  # BigCapital volumes
  bigcapital-mysql:
    name: infrastructure_bigcapital_mysql
    driver: local
  bigcapital-mongo:
    name: infrastructure_bigcapital_mongo
    driver: local
  bigcapital-redis:
    name: infrastructure_bigcapital_redis
    driver: local

  # Corteza volumes
  corteza-db:
    name: infrastructure_corteza_db
    driver: local
  corteza-data:
    name: infrastructure_corteza_data
    driver: local

# ============================================
# NETWORKS
# ============================================
networks:
  infrastructure_network:
    driver: bridge
    name: infrastructure_network
